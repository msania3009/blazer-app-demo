name: Build, Push, and Deploy Blazor App to ACI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout
    - name: Checkout code
      uses: actions/checkout@v4

    # 2️⃣ Login to Azure using Service Principal
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 3️⃣ Login to ACR
    - name: Login to Azure Container Registry
      run: az acr login --name cmagcr

    # 4️⃣ Build and Push Docker image
    - name: Build and Push Docker Image
      run: |
        IMAGE_TAG=${{ github.run_number }}
        docker build -t cmagcr.azurecr.io/blazorappdemo:latest ./BlazorAppDemo
        docker push cmagcr.azurecr.io/blazorappdemo:latest

    # 5️⃣ Deploy or Update ACI Container
    - name: Deploy or Update ACI Container
      shell: bash
      run: |
        RG_NAME=devRG
        ACR_SERVER=cmagcr.azurecr.io
        IMAGE=$ACR_SERVER/blazorappdemo:latest
        CONTAINER_NAME=blazorappdemo
        ACR_USERNAME=$(az acr credential show --name cmagcr --query username -o tsv)
        ACR_PASSWORD=$(az acr credential show --name cmagcr --query passwords[0].value -o tsv)

        echo "Deploying container instance..."

        # Delete existing container if present
        if az container show --name $CONTAINER_NAME --resource-group $RG_NAME &>/dev/null; then
          echo "Deleting existing container..."
          az container delete --name $CONTAINER_NAME --resource-group $RG_NAME --yes
        fi

        # Create a new container instance (Linux)
        az container create --resource-group $RG_NAME --name $CONTAINER_NAME --image $IMAGE --os-type Linux --registry-login-server $ACR_SERVER --registry-username $ACR_USERNAME --registry-password $ACR_PASSWORD --dns-name-label blazorappdemo${{ github.run_number }} --ports 80 --restart-policy Always

        # Show the public FQDN of the container
        echo "✅ Container deployed successfully!"
        az container show --name $CONTAINER_NAME --resource-group $RG_NAME --query ipAddress.fqdn -o tsv
